/*! Copyright (c) 2017 Mediarithmics; All Rights Reserved */
!function(a){function b(d){if(c[d])return c[d].exports;var e=c[d]={exports:{},id:d,loaded:!1};return a[d].call(e.exports,e,e.exports,b),e.loaded=!0,e.exports}var c={};return b.m=a,b.c=c,b.p="",b(0)}([function(a,b,c){c(1),c(5),c(2),c(6),c(4),c(3),c(7),c(8),!function(a){"use strict";function b(a){for(var b=0;b<o._names.length;b++)a(o._names[b])}function d(){b(function(a){o[a].pageQuit()})}function e(){var a=o._queue||{};b(function(a){o[a]&&o[a].context||(o[a]=new k(a,m),window[a]=o[a],"mics"===a&&(o[a]._setConfig=o._setConfig))}),b(function(b){f(b,a[b])})}function f(a,b){for(;b.length;){var c=b.shift();n.debug("executing ",c,"on",a),o[a].callMicsMethod(c.method,c.args)}}var g=window.navigator.userAgent;if(!/googlebot|bingbot|yandexbot|baiduspider/i.test(g)){var h=!1,i=null,j=(new Date).getTime(),k=c(8),l=c(6).readCookie,m=l("mics_debug_tag"),n=c(2)("tag",m),o=c(3).mics;if(o._tagVersion)return n.warn("The tag was already loaded, aborting."),void e();o._tagVersion="1.2.3",o._reset=function(a){h&&!a||(h=!0,n.info("mics.reset"),b(function(a){o[a]._reset()}),o._token=null,o._initialized=!1,i&&(i.clearWatchDog(),i=null),o._startTime||(o._startTime=j))},o._setConfig=function(a){n.info("mics._setConfig",a),b(function(b){o[b].setConfig(a)})},window.mics=window.mics||{},window.mics._setConfig=o._setConfig,window.mics._tagVersion="1.2.3",o._setOperatorId=function(a,c){b(function(b){o[b].setOperatorId(a,c)})},o._setUAID=function(a,c,d){b(function(b){o[b]._setUAID(a,c,d)})},e(),window.addEventListener&&window.addEventListener("beforeunload",d,!1)}}(c)},function(a,b,c){!function(b){"use strict";function d(a,b){for(var c=0;c<a.length;c++)if(a[c]===b)return!0;return!1}var e=c(4);a.exports=function(a,b,d,e){this.finished=!1,this.ran=!1,this.operators=a,this.retrievedIds=[],this.timeout=b,this.watchDog=null,this.options=e,this.console=c(2)("CookieMatcher",d)},a.exports.prototype={end:function(){return this.gatherIdEnd},panicCallback:function(a){this.panicFn=a},gatherOperatorsIds:function(){this.console.info("gatherOperatorsIds",this.operators);for(var a=0;a<this.operators.length;a++)this.gatherId(this.operators[a]);var b=this;this.timeout>0&&(this.watchDog=window.setTimeout(function(){b._timeout()},this.timeout))},setEtid:function(a){this.etid=a,this.finishIfPossible()},gatherId:function(a){var b=this;e.loadScript(this.options.gather_operator_id_url+"?opid="+a,function(c){c&&(b.console.info("error while gather_id",a),b.setOperatorId(a,null))})},setOperatorId:function(a,b){d(this.retrievedIds,b)||(this.console.log("setId("+a+", "+b+")"),this.retrievedIds.push(b),this.finished=this.retrievedIds.length===this.operators.length,this.finishIfPossible())},finishIfPossible:function(a){var b=this;if(b.console.log("try to finish, panicMode:",b.panicMode,"etid:",b.etid,"finished",b.retrievedIds.length),b.etid&&b.finished||a){b.gatherIdEnd=(new Date).getTime();for(var c=[];b.retrievedIds.length;){var d=b.retrievedIds.shift();d&&c.push(d)}b.console.log("finishing.");var f=b.options.cookie_matching_url+"?";b.etid&&(f=f+"etid="+b.etid+"&"),f=f+"utidl="+c.join(","),e.loadScript(f,function(a){a&&b.panicFn&&(b.console.info("failed to load get_id"),b.panicFn("$get_id_failed"))}),b.ran=!0,b.destroy()}},_timeout:function(){this.finishIfPossible(!0)},updateCookieMatchingOut:function(a){var b=this;if(b.ran){var c=b.options.update_cookie_matching_out_url+"?";c=c+"vid="+a+"&ops=bsw",(b.options.override_transport||e.loadPixel)(c,function(a){a&&b.console.error("error while loading cmout !",a)})}},destroy:function(){window.clearTimeout(this.watchDog)}}}(c)},function(a,b,c){!function(b){"use strict";var d=c(3);a.exports=function(a,b){return function(c){function e(c){return function(){if(b&&window.console&&window.console[c])try{var e=Array.prototype.slice.apply(arguments),f=d.durationFromSnippetStart((new Date).getTime())/1e3;e.unshift(a),e.unshift("mics "+f.toFixed(3)+" s"),window.console[c].apply(window.console,e)}catch(g){}}}for(var f={},g=0;g<c.length;g++)f[c[g]]=e(c[g]);return f}("log debug info warn error".split(" "))}}(c)},function(a,b,c){!function(){"use strict";var b=window.scimhtiraidem;if(window.mics&&window.mics._snippetVersion&&(window.scimhtiraidem||(b=window.scimhtiraidem={},b._queue={},b._names=[]),b._queue.mics=window.mics._queue,b._snippetVersion=b._snippetVersion||window.mics._snippetVersion,b._startTime=window.mics._startTime,b._names.push("mics"),b.mics=window.mics),!b)throw new Error("mics is not defined. Did you used the provided snippet ?");a.exports.mics=b,a.exports.durationFromSnippetStart=function(a){return a?a-b._startTime:null}}(c)},function(a,b,c){!function(){"use strict";b.loadPixel=function(a,b){var c=document.createElement("img");c.style.display="none",c.style.width=c.style.height="0px",b&&(c.onload=function(){b(null,a)},c.onerror=function(){var c=new Error("error while loading"+a);c.url=a,b(c,null)}),c.setAttribute("src",a)},b.loadScript=function(a,b){var c=document.createElement("script");c.setAttribute("type","text/javascript"),c.setAttribute("src",a),c.setAttribute("async","true"),b&&(c.onload=function(){b(null,a)},c.onerror=function(){var c=new Error("error while loading"+a);c.url=a,b(c,null)}),document.getElementsByTagName("script")[0].parentNode.appendChild(c)}}(c)},function(a,b,c){!function(b){"use strict";var d=c(6).readCookie;a.exports=function(a){this.properties={},this.options=a,this.ready=!1},a.exports.prototype={_parseSearch:function(a){for(var b,c,d,e=a.substring(1).split("&"),f={},g=0;g<e.length;g++)b=e[g].split("="),c=b[0],d=b[1],f[c]=decodeURIComponent(d).replace(/\+/g," ");return f},_setReady:function(){this.ready=!0},isReady:function(){return this.ready},readPage:function(){this.properties.$referrer=document.referrer,this.properties.$url=""+document.location;for(var a="utm_source utm_medium utm_term utm_content utm_campaign".split(" "),b=this._parseSearch(window.location.search),c=0;c<a.length;c++){var e=a[c];b[e]&&(this.properties["$"+e]=b[e])}if(this.options.local_cookie_name){var f=d(this.options.local_cookie_name);f&&(this.properties.raw_cookie=f)}var g=d("mics_uaid");g&&(this.properties.$uaid=g);var h=d("mics_vid");h&&(this.properties.$vid=h);var i=parseInt(d("mics_lts"),10);isNaN(i)||(this.properties.$lts=i)},getVid:function(){return this.properties.$vid},getLts:function(){return this.properties.$lts},getCookie:function(){return this.properties.$uaid},updateUAID:function(a,b){var c=new Date;c.setTime(c.getTime()+24*this.options.cookie_max_age_in_days*60*60*1e3),a&&(this.properties.$vid=a,document.cookie="mics_vid="+encodeURIComponent(a)+";expires="+c.toGMTString()+";path=/"),b&&(this.properties.$lts=b,document.cookie="mics_lts="+encodeURIComponent(b)+";expires="+c.toGMTString()+";path=/"),this._setReady()}}}(c)},function(a,b,c){!function(a){"use strict";function d(a){for(var b=document.cookie.split(";"),c=0;c<b.length;c++){var d=b[c].replace(/ /g,"").split("=");if(d[0]===a)return e.debug("found cookie",d[0],d[1]),d[1]}return null}var e=c(2)("CookieReader",!1);b.readCookie=d}(c)},function(a,b,c){!function(b){"use strict";function d(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}var e={$user_account_id:"$cuid"},f=c(3),g=c(4);a.exports=function(a,b,d,e,f){this.console=c(2)("EventPusher-"+a,f.debug),this.console.info("new EventPusher()"),this.callQueue=[],this.currentPage=d,this.transportFunction=f.override_transport,this.cookieMatcher=e,this.tagStart=b,this.globalProperties={},this.eventsRunning=0,this.endPointUrl=f.end_point_url,this.panicMode=!1,this.errorEvents=[]},a.exports.prototype={sendCallQueue:function(a,b){for(var c=this.callQueue,e=b||{};c.length;){var g=f.durationFromSnippetStart((new Date).getTime());g&&(e.$delay={$push:g,$start:f.durationFromSnippetStart(this.tagStart),$gather_id_end:f.durationFromSnippetStart(this.cookieMatcher.end())});var h=c.shift();h=d(h,this.currentPage.properties),h=d(h,this.globalProperties),h=d(h,e),this.console.info("pushing",h);var i=this.endPointUrl+"?"+this.generateHttpQuery(h);this.eventsRunning++,a(i,this.pixelSentCallback(this))}this.panicMode||(this.console.info("complete before panicMode, clearing watchDog"),this.clearWatchDog())},clearWatchDog:function(){this.watchDog&&(this.console.log("clearing watchdog"),window.clearTimeout(this.watchDog),this.watchDog=null)},setWatchDog:function(a){this.console.info("setup watchdog timer to ",a),this.clearWatchDog();var b=this;this.watchDog=setTimeout(function(){b.panic("$count_down_1")},a)},setPanicCallback:function(a){this.panicFn=a},triggerCallsIfPossible:function(){if(this.console.info("trigger calls if possible: currentPage:",this.currentPage,"panicMode:",this.panicMode,", global:",this.globalProperties,"callQueue:",this.callQueue),this.currentPage&&this.currentPage.isReady()&&this.globalProperties.$etid||this.panicMode){var a={};this.panicMode&&(a.$error=this.panicReason),this.sendCallQueue(this.transportFunction||g.loadPixel,a)}},pixelSentCallback:function(a){return function(b,c){if(b?(a.errorEvents.push(b.url),a.eventsRunning--,a.console.info("error with",b)):(a.console.info("sucessfully sent",c),a.eventsRunning--),a.finishedCallbackFunction&&0===a.eventsRunning){a.console.info("calling callback function: eventsRunning:",a.eventsRunning,"errors:",a.errorEvents);try{a.finishedCallbackFunction.apply(0===a.errorEvents.lenght)}catch(d){a.console.error("error has occured while calling callback function",d)}}}},pushDefault:function(){this.push("$page_view")},push:function(a,b){if(!this.currentPage)throw new Error("mics is not initialized, call mics.init(YOUR_TOKEN) first !");b=b||{},b.$ev=a,this.callQueue.push(b),this.triggerCallsIfPossible()},addProperties:function(a){this.globalProperties=d(this.globalProperties,a),this.console.info("properties: ",this.globalProperties)},generateHttpQuery:function(a){var b=[];for(var c in a)if(a.hasOwnProperty(c)&&"object"!=typeof a[c]){var d=e[c]||c;b.push(encodeURIComponent(d)+"="+encodeURIComponent(a[c]))}else if("object"==typeof a[c]&&"object"==typeof JSON){var f=e[c]||c;b.push(encodeURIComponent(f)+"=jso-"+encodeURIComponent(JSON.stringify(a[c])))}return b.join("&")},panic:function(a){this.console.info("switching to panic mode ! reason:",a),this.panicMode=!0,this.panicReason=a,this.triggerCallsIfPossible()},onFinish:function(a,b){this.finishedCallbackFunction=a,this.setWatchDog(b)},beacon:function(a){navigator.sendBeacon(a)},pageQuit:function(){if(this.console.log("page is unloading"),navigator.sendBeacon){for(this.console.log("send call queue with navigator.beacon");this.errorEvents.length;)this.beacon(this.errorEvents.shift());this.eventsRunning>0&&this.push("$quit_while_running"),this.sendCallQueue(this.beacon,{$error:"page_quit"})}}}}(c)},function(a,b,c){!function(b){"use strict";function d(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}var e="https://cookie-matching.mediarithmics.com",f=function(){var a,b=["init","call","config","push","pushDefault","addProperties","addProperty","onFinish","onStart","_reset"],c=[],d={};for(a=0;a<b.length;a++)d[b[a]]=!0;for(a=0;a<c.length;a++)d[c[a]]=!0;return d}(),g=(new Date).getTime(),h=c(1),i=c(5),j=c(4),k=c(7),l=c(3).mics,m={domain_id:1,cookie_matching_url:e+"/v1/getids",gather_operator_id_url:e+"/v1/gather_id",update_cookie_matching_out_url:e+"/v1/update_cm_out",get_id_path:"/v1/get_id",domain_name:"events.mediarithmics.com",protocol:"https://",events_path:"/v1/visits/pixel",config_server_url:"https://events.mediarithmics.com/v1/conf.js",cookie_max_age_in_days:365,cookie_refresh_in_days:10,local_cookie_name:null,gather_id_timeout_ms:2e3,global_timeout_ms:3e3,override_transport:null};a.exports=function(a,b){this.console=c(2)(a,b),this.cookieMatcher=null,this.eventPusher=null,this.currentPage=null,this.context=a,this.options=d({debug:b},m),this.globalProperties={$sv:l._snippetVersion},this.console.info("creating tag object",this.globalProperties)},a.exports.prototype={fetchConfig:function(){j.loadScript(this.options.config_server_url)},call:function(a){var b=Array.prototype.slice.apply(arguments).splice(1);this.callMicsMethod(a,b)},callMicsMethod:function(a,b){f[a]?this[a].apply(this,b):this.console.error("The method '"+a+"' is not supported.")},onStart:function(a){a&&a.apply()},setOperatorId:function(a,b){this.cookieMatcher&&this.cookieMatcher.setOperatorId(a,b)},fetchUAID:function(a,b,c){var d=new Date;if(d.setTime(d.getTime()-24*this.options.cookie_refresh_in_days*60*60*1e3),b&&c>d.getTime()){var e=this;setTimeout(function(){e._setUAID(a,b,c)},0)}else this.cookieMatcher.gatherOperatorsIds()},clearWatchDog:function(){this.eventPusher.clearWatchDog()},setConfig:function(a){this.currentPage&&(this.console.info("setConfig",a),this.addProperties({$etid:a.etid}),this.cookieMatcher.setEtid(a.etid),this.eventPusher.triggerCallsIfPossible())},_setUAID:function(a,b,c){this.currentPage&&(b&&!this.set&&(this.set=!0,this.console.log("_setUAID(",b,c,")"),this.currentPage.updateUAID(b,c),this.cookieMatcher.updateCookieMatchingOut(b,c)),this.eventPusher.triggerCallsIfPossible())},init:function(a){if("undefined"==typeof a)throw new Error(this.context+".init : use a token string or an object");var b=null;b="string"==typeof a?d(this.options,{mode:"VISIT",site_token:a,domain_name:this.options.domain_name}):d(this.options,a),a.cookie_matching_url?this.console.info("overriding cookie_matching_url with ",a.cookie_matching_url):a.domain_name&&(b.cookie_matching_url=b.protocol+b.domain_name+b.get_id_path,this.console.info("using custom domain, cookie_matching_url will be ",b.cookie_matching_url)),this.console.info("mcsObj.config, new configuration is",b),this.options=b;var c=null,e=null;if("VISIT"===b.mode)c="/v1/visits/pixel",e=this.globalProperties.$site_token=b.site_token;else{if("TOUCH"!==b.mode)throw new Error(this.context+".init : invalid mode ("+b.mode+")");c="/v1/touches/pixel",e=this.globalProperties.$dat_token=b.datamart_token}if(null!==this.eventPusher)return void this.console.warn(this.context+" was already initialized, stop initialization");if("string"!=typeof e)throw new Error(this.context+".init : the token must be a string");if(0===e.length)throw new Error(this.context+".init : the token must be a non-empty string");this.currentPage=new i(b),this.cookieMatcher=new h(["goo","apx"],b.gather_id_timeout_ms,b.debug,b),this.fetchConfig(),this.currentPage.readPage(),this.fetchUAID(this.currentPage.getCookie(),this.currentPage.getVid(),this.currentPage.getLts());var f={end_point_url:b.protocol+b.domain_name+c,debug:b.debug,override_transport:b.override_transport};this.eventPusher=new k(this.context,g,this.currentPage,this.cookieMatcher,f),this.eventPusher.addProperties(this.globalProperties),this.eventPusher.setWatchDog(b.global_timeout_ms),this.cookieMatcher.panicCallback(this.eventPusher.panic),this.addProperty("$tv","1.2.3")},pageQuit:function(){this.eventPusher&&this.eventPusher.pageQuit()},onFinish:function(a,b){this.eventPusher.onFinish(a,b)},pushDefault:function(){this.push("$page_view")},push:function(a,b){if(!this.eventPusher)throw new Error(this.context+" is not initialized, call "+this.context+".init(YOUR_TOKEN) first !");this.eventPusher.push(a,b)},addProperty:function(a,b){this.console.debug("addProperty",a,b);var c={};c[a]=b,this.addProperties(c)},addProperties:function(a){this.console.debug("addProperties",a),this.eventPusher?this.eventPusher.addProperties(a):this.globalProperties=d(this.globalProperties,a)},_reset:function(){this.console.info("reset ",this.context),this.set=!1,this.options=d({debug:this.options.debug},m),this.globalProperties={$sv:l._snippetVersion},this.cookieMatcher=null,this.eventPusher=null,this.currentPage=null},config:function(a){return a=a||{},this.options=d(this.options,a),a.cookie_matching_url?this.console.info("overriding cookie_matching_url with ",a.cookie_matching_url):a.domain_name&&(this.options.cookie_matching_url=this.options.protocol+this.options.domain_name+this.options.get_id_path,this.console.info("using custom domain, cookie_matching_url will be ",this.options.cookie_matching_url)),this.console.info("mcsObj.config, new configuration is",this.options),this.options}}}(c)}]);